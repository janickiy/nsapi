Установка приложения на сервер под управлением Docker-контейнеров
=================================================================

При использовании Docker-сервисов на сервере, с вас уходит ответственость по настройке отдельных сервисов, все они настраиваются в рамках самого приложения

Структура и настройка файлов приложения:
----------------------------------------
* deploy/docker - в данной папке находятся все необходимые файлы для сборки проекта на сервере, установке контейнеров и их настройке
* deploy/docker/php.ini - php-fpm.ini файл. Сейчас по дефолту. Если есть необходимость настройки php - редактируйте, заливайте на сервер, перезапускайте контейнер
* deploy/docker/nginx.conf - nginx конфиг вашего приложения. Сейчас там имеется только одна переменная, получаемая из вне - ${SERVER_NAME}. При необходимости
можно добавить больше. ВАЖНО! значок $ должен быть написан как ${DOLLAR}. Все пути в файле относительны монтируемой директории внутри контейнера
* deploy/docker/docker-compose.yml - файл конфигурации контейнеров. Здесь распологаются контейнеры сервисов (php, nginx, postgres), а также крон и демоны (супервизор)

Структура и настройка файлов сервере:
----------------------------------------
В папке deploy/server_examples/docker находятся файлы, которые необходимо перенести на сервер в одну директорию (напр. /opt/baseapp). 
Сами файлы:
* deploy/server_examples/docker/build-project.sh - файл, содержащий информацию по гиту, ветке, командах выполнения. Должны быть права на выполнение этого файла
* deploy/server_examples/docker/docker.yml - данный файл является аналогом deploy/docker/docker-compose.yml и носит за собой конфигурационный характер. Оба эти файла 
мёржаться. В этом файле рекомендуется прописывать пароли, порты, домены (чтобы не тащить это в гит)
* deploy/server_examples/docker/docker-ssh.yml - также файл настройки. Необходимо прописать домашнюю директорию пользователя на сервере
* deploy/server_examples/docker/exec_docker_command.sh - не трогать

Порядок установки:
------------------
* Установить на сервер Unix-подобную систему (не влияет на работу docker сборки), docker, docker-compose
* Настроить файлы deploy/docker перед выливкой
* Сгенерировать ssh-ключ на сервере
* Раздать для него deploy keys в гите
* Скопировать файлы deploy/server_examples/docker/ на сервер в /opt/your-project-name
* Отредактировать файлы deploy/server_examples/docker в соотвествие с вашими настройками
* Выполнить ./build-project.sh

Если вы всё сделали правильно, начнется скачивание контейнеров, разворот приложения, заполнение settings.json. 
По резульату работы скрипта ваше приложение будет доступно по выбранному домену

Полезные команды Docker:
------------------------
* docker ps -a                                              Показывает состояние контейнеров
* docker start/stop/restart container_name                  Остановка/Запуск/Перезапуск контейнера
* docker exec -it container_name command                    Выполнение команды от имени контейнера (флаг -it ОБЯЗАТЕЛЕН! иначе ваш контейнер может зависнуть в выполнении)
* docker cp container_id:/container_path /server_path       Копирование файлов из контейнера на сервер

Примеры:

* docker exec -it php php yii cache/flush-all               Сброс кеша
* docker exec -it postgres psql -U postgres                 Вход в консоль postgres контейнера с базой данных

Дополнительная информация:
--------------------------
* При измении кода воркеров, конфигов контейнеров необходимо руками перезапускать контейнеры
* Обращение к контейнерам проиходит не по IP (напрм. для Rabbit http://127.0.0.1:5672), а по имени контейнера (http://rabbitmq)
* Порты наружу нужно прокидывать в докер конфиге
* Git находится в PHP контейнере
* Изнутри одного контейнера нельзя вызывать другой (они ничего друг о друге не знают)
* Если вы временного присотанавливаете контейнер, то после сборки (./build-project.sh) он снова запустится
* Приложение монтируется из под root
* Если вам нужны дополнительные сервисы (centrifugo, nodejs и пр.) обратитесь к разработчикам за помощью


